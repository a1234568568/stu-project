<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Welcome GoLa</title>

    <style>
        * {
            padding: 10px;
            margin: 0%;
            font-family: Microsoft JhengHei, SimHei;


        }

        #app {

            padding: 0px 10px 15px 10px;
            width: 90%;
            height: 80%;
            margin: auto;
            position: relative;
            text-align: center;
        }



        .imgdiv {
            width: 70%;
            height: 60%;
            margin: 0px auto;


        }

        #button {
            display: block;
            border: none;
            background-color: brown;
            width: 25%;
            margin: auto;
            font-weight: bold;
            padding: 10px;
            color: wheat;
            font-size: 20px;
        }

        p {
            background-color: none;
        }

        .pic {
            width: 80%;

        }

        .output {
            font-size: 40px;
        }
    </style>
</head>

<body>
    <img src="/img/16pic_8921951_b.jpg" alt="background"
        style="position:absolute; z-index:-1;width: 87%;height: 99%;left: 5.5%;top:-2%;">
    <div id="app">
        <!--<h1>æ­¡è¿å•è·¯ ğŸš“</h1>-->

        <div class='imgdiv'>

            <img class="pic" v-if="isWating" src="/img/waiting2.gif" alt="ç­‰å¾…ä¸­">
            <img class="pic" v-if="isLoading" src="/img/speak.gif" alt="è®€å–ä¸­">
        </div>
        <p :class="{'output': isLoading}">{{ output }}</p>
        <button @click="search" id="button">æˆ‘ æƒ³ å• è·¯ ğŸš–</button>
        <div v-for="store in stores" class="imgdiv">
            <p>{{ store.name }} {{ store.type }}</p>
            <img v-if="store.src!=''" class="pic" :src="store.src" :alt="store.name"
                style="margin: 0; border-style: solid;border-width: 15px;border-color:white; box-shadow:9px 9px 20px dimgray;">
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>
    <script>
        var vm = new Vue({
            el: '#app',
            data: {
                isWating: true, //å‘ˆç¾èµ°è·¯åœ–
                isLoading: false, // å‘ˆç¾è¬›è©±åœ–
                output: '', // å‘ˆç¾æ–‡å­—
                stores: [], // å‘ˆç¾åº—å®¶è³‡æ–™
                ws: null,
            },
            methods: {
                search() {
                    if (this.isLoading) {
                        return
                    }
                    this.isWating = false
                    this.isLoading = true
                    this.stores = []

                    this.display('ğŸ¤ è«‹èªª~', 'è«‹èªª')

                    window.SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition
                    if (!window.SpeechRecognition) {
                        this.display('ğŸ§ ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´éº¥å…‹é¢¨ï¼Œè«‹ä½¿ç”¨Chromeï¼Œå†è©¦ä¸€æ¬¡ï¼', 'ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´éº¥å…‹é¢¨ï¼Œè«‹ä½¿ç”¨Chromeï¼Œå†è©¦ä¸€æ¬¡ï¼')
                        this.isWating = true
                        this.isLoading = false
                        return
                    }

                    let success = false
                    const recognition = new SpeechRecognition() // æ”¶ä½¿ç”¨è€…çš„éº¥å…‹é¢¨è²éŸ³
                    recognition.lang = 'zh-TW'
                    recognition.onresult = (e) => { // å¦‚æœæœ‰èªªè©±ï¼Œé€™é‚Šæœƒæ”¶åˆ°æ–‡å­—
                        if (e.results.length == 0 || e.results[0].length == 0) {
                            return
                        }

                        success = true
                        const text = e.results[0][0].transcript
                        this.display(`ğŸ§ é–‹å§‹æœå°‹:${text}`, `é–‹å§‹æœå°‹`)
                        this.ws.send(text)
                    }

                    recognition.onend = (e) => { // æ”¶éŸ³çµæŸæœƒè·‘åˆ°é€™é‚Šï¼Œå¦‚éæ”¶éŸ³æ²’æˆåŠŸæœƒæç¤º
                        if (success) {
                            return
                        }
                        this.isWating = true
                        this.isLoading = false
                        this.display('ğŸ§ è½ä¸æ¸…æ¥šï¼Œè«‹åœ¨èªªä¸€æ¬¡', 'è½ä¸æ¸…æ¥šï¼Œè«‹åœ¨èªªä¸€æ¬¡')
                        return
                    }

                    setTimeout(() => recognition.start(), 1000)

                },
                transform(store) {
                    let data = {
                        id: store.id,
                        name: store.store_name,
                        type: store.store_type,
                        src: '',
                    }

                    if (store.id !== '') {
                        // let src = '/img/store/' + store.id + '.gif'
                        // ç”¨Noç•¶æª”åçš„è©±ï¼Œå‘ˆé¡¯åœ–ç‰‡åªè¦æ‰“ä¸Šé¢é€™è¡Œï¼Œæœƒå‘ˆç¾ /img/BLB010.gif
                        let src = '/img/'

                        if (store.id[0] === 'C') {
                            src += 'C'
                        } else {
                            src += 'B'//  /img/B
                        }

                        switch (store.floor) {
                            case 'F1':
                                src += ' 1F'
                                break;
                            case 'LB':
                                src += ' LB'// /img/B LB GIF/Aquascutum.gif
                                break;
                        }

                        src += ' GIF/' + store.store_name + '.gif'

                        data.src = src
                    }

                    return data
                },
                finish(data) {
                    this.isWating = false
                    this.isLoading = false
                    this.stores = []
                    for (const key in data.main) {
                        let store = data.main[key]
                        this.stores.push(this.transform(store))
                    }

                    if (this.stores.length === 0) {
                        for (const key in data.about) {
                            let store = data.about[key]
                            this.stores.push(this.transform(store))
                        }
                    }

                    setTimeout(() => {
                        console.log('åˆå§‹åŒ–', this.stores)
                        this.stores = [];
                        this.isWating = true
                        this.output = ''
                    }, 30000)
                },
                display(text, sound) {
                    this.output = text
                    const u = new SpeechSynthesisUtterance(); // é€™å€‹å¯ä»¥ç”¨ä¾†èªªè©±
                    u.lang = 'zh-TW'
                    u.text = sound
                    window.speechSynthesis.speak(u)
                }
            },
            mounted() {
                let url = window.location.host + '/stu'
                if (window.location.protocol === 'http:') {
                    url = 'ws://' + url
                } else {
                    url = 'wss://' + url
                }

                this.ws = new WebSocket(url)
                this.ws.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data)
                        this.display('ğŸ§ ' + data.text, data.text)
                        this.finish(data)
                    } catch (error) {
                        this.display('ğŸ¤ ' + e.data + "~")
                    }
                }
            }
        })
    </script>
</body>

</html>

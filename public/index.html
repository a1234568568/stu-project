<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Welcome GoLa</title>

    <style>
        * {
            padding: 10px;
            margin: 0%;
            font-family:Microsoft JhengHei,SimHei;
            
            
        }

        #app {
            
            padding: 0px 10px 15px 10px;
            width: 90%;
            height: 80%;                      
            border-style:double;
            border-color:brown;
            border-width: 10px 0px 10px 0px;
           
            margin: auto;
            
            text-align:center;            
        }

        

        #imgdiv{
            width: 70%;
            height: 60%;
            margin: 0px auto;
                        
        }

        #button{
            display: block;
            border: none;
            background-color: brown;
            width: 25%;
            margin: auto;
            font-weight: bold;
            padding: 10px;
            color: white;
            font-size: 20px;
        }

        p{
            background-color: white;
        }

        .pic {
            width: 80%;
        }
    </style>
</head>

<body>
    <div id="app">
        <!--<h1>Ê≠°ËøéÂïèË∑Ø üöì</h1>-->       
        <div id='imgdiv'>
            <img class="pic" v-if="isWating" src="/img/waiting2.gif" alt="Á≠âÂæÖ‰∏≠" >
            <img class="pic" v-if="isLoading" src="/img/speak.gif" alt="ËÆÄÂèñ‰∏≠">
        </div>
        <p>{{ output }}</p>
        <button @click="search" id="button">Êàë ÊÉ≥ Âïè Ë∑Ø üöñ</button>
        <div v-for="store in stores">
            <p>{{ store.name }} {{ store.type }}</p>
            <img v-if="store.src!=''" class="pic" :src="store.src" :alt="store.name">
        </div>        
    </div>
    

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>
    <script>
        var vm = new Vue({
            el: '#app',
            data: {
                isWating: true, //ÂëàÁèæËµ∞Ë∑ØÂúñ
                isLoading: false, // ÂëàÁèæË¨õË©±Âúñ
                output: '', // ÂëàÁèæÊñáÂ≠ó
                stores: [], // ÂëàÁèæÂ∫óÂÆ∂Ë≥áÊñô
                ws: null,
            },
            methods: {
                search() {
                    if (this.isLoading) {
                        return
                    }
                    this.isWating = false
                    this.isLoading = true
                    this.ws.send('yes')
                },
                transform(store) {
                    let data = {
                        id: store.id,
                        name: store.store_name,
                        type: store.store_type,
                        src: '',
                    }

                    if (store.id !== '') {
                         // let src = '/img/store/' + store.id + '.gif'
                        // Áî®NoÁï∂Ê™îÂêçÁöÑË©±ÔºåÂëàÈ°ØÂúñÁâáÂè™Ë¶ÅÊâì‰∏äÈù¢ÈÄôË°åÔºåÊúÉÂëàÁèæ /img/BLB010.gif
                        let src = '/img/'

                        if (store.id[0] === 'C') {
                            src += 'C'
                        } else {
                            src += 'B'//  /img/B
                        }

                        switch (store.floor) {
                            case 'F1':
                                src += ' 1F'
                                break;
                            case 'LB':
                                src += ' LB'// /img/B LB GIF/Aquascutum.gif
                                break;
                        }

                        src += ' GIF/' + store.store_name + '.gif'

                        data.src = src
                    }

                    return data
                },
                finish(data) {
                    this.isLoading = false
                    this.stores = []
                    for (const key in data.main) {
                        let store = data.main[key]
                        this.stores.push(this.transform(store))
                    }

                    if (this.stores.length === 0) {
                        for (const key in data.about) {
                            let store = data.about[key]
                            this.stores.push(this.transform(store))
                        }
                    }
                    
                    setTimeout(() => {
                        console.log('ÂàùÂßãÂåñ', this.stores )
                        this.stores = [];
                        this.isWating = true
                        this.output = ''
                    }, 30000)
                },
                display(text) {
                    this.output = text
                }
            },
            mounted() {
                let url = window.location.host + '/stu'
                if (window.location.protocol === 'http:') {
                    url = 'ws://' + url
                } else {
                    url = 'wss://' + url
                }

                this.ws = new WebSocket(url)
                this.ws.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data)
                        this.display('üéß ' + data.text)
                        this.finish(data)
                    } catch (error) {
                        this.display('üé§ ' + e.data)
                    }
                }
            }
        })
    </script>
</body>

</html>
